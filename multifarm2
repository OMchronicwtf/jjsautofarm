-- =======================
-- Farming Module (Normal + MultiQuest + SuperKill)
-- version: 1.1.3
-- =======================
return function(player, QuestEvent, quests, teleportZones, RunService, FarmTab)
    local selectedQuests = {}
    local multiQuestEnabled = false
    local autoFarmEnabled = false
    local superKillEnabled = false
    local heartbeatConnection
    local zoneLockConnection

    -- ======= Configurable sliders =======
    local behindDistance = 8
    local aboveHeight = 1

    local distanceSlider = FarmTab:CreateSlider({
        Name = "Distance Behind Enemy",
        Range = {1, 15},
        Increment = 0.5,
        Suffix = "Studs",
        CurrentValue = behindDistance,
        Flag = "DistanceSlider",
        Callback = function(value)
            behindDistance = value
        end
    })

    local heightSlider = FarmTab:CreateSlider({
        Name = "Height Above Enemy",
        Range = {0, 10},
        Increment = 0.5,
        Suffix = "Studs",
        CurrentValue = aboveHeight,
        Flag = "HeightSlider",
        Callback = function(value)
            aboveHeight = value
        end
    })

    FarmTab:CreateButton({
        Name = "Set Default",
        Callback = function()
            behindDistance = 8
            aboveHeight = 1
            distanceSlider:Set(behindDistance)
            heightSlider:Set(aboveHeight)
        end
    })

    -- ======= Helpers =======
    local function IsInQuest()
        local questFrame = player.PlayerGui:FindFirstChild("Quest") and player.PlayerGui.Quest:FindFirstChild("Mission")
        return questFrame and questFrame.Visible or false
    end

    local function TeleportToZone(level)
        for _, zone in ipairs(teleportZones) do
            if level >= zone.Min and level <= zone.Max then
                local hrp = player.Character:WaitForChild("HumanoidRootPart")
                hrp.CFrame = zone.CFrame
                return zone.CFrame
            end
        end
    end

    local function LockAtZone(zoneCFrame)
        local hrp = player.Character:WaitForChild("HumanoidRootPart")
        if zoneLockConnection then
            zoneLockConnection:Disconnect()
            zoneLockConnection = nil
        end
        zoneLockConnection = RunService.Heartbeat:Connect(function()
            hrp.Velocity = Vector3.new(0,0,0)
            hrp.RotVelocity = Vector3.new(0,0,0)
            hrp.CFrame = zoneCFrame
        end)
    end

    local function DetachZoneLock()
        if zoneLockConnection then
            zoneLockConnection:Disconnect()
            zoneLockConnection = nil
        end
    end

    local function AttachSuperKill(enemy)
        if enemy and enemy:FindFirstChild("Humanoid") and superKillEnabled then
            local humanoid = enemy.Humanoid
            local initialHealth = humanoid.Health
            humanoid.HealthChanged:Connect(function()
                if humanoid.Health <= initialHealth * 0.9 then
                    humanoid.Health = 0
                end
            end)
        end
    end

    local function GetSafeBehindPosition(enemyHRP)
        local rootPos = enemyHRP.Position
        local lookVec = enemyHRP.CFrame.LookVector
        return rootPos - lookVec * behindDistance + Vector3.new(0, aboveHeight, 0)
    end

    local function FarmQuest(questData)
        if not questData then return end
        local hrp = player.Character:WaitForChild("HumanoidRootPart")
        local zoneCFrame = TeleportToZone(questData.MinLevel)

        -- Wait for quest
        task.wait(0.3)
        if not IsInQuest() then
            QuestEvent:FireServer({ Quest = questData.QuestName, Type = "RepeatQuest" })
        end
        repeat task.wait(0.1) until IsInQuest()

        -- Farm loop
        repeat
            local enemy = nil
            for _, mob in pairs(workspace.Mobs:GetChildren()) do
                local levelNum = tonumber(mob.Name:match("Lv(%d+)"))
                if levelNum == questData.MinLevel and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") then
                    enemy = mob
                    break
                end
            end

            if enemy and enemy.Parent and enemy:FindFirstChild("HumanoidRootPart") then
                -- Enemy found: detach zone lock
                DetachZoneLock()

                local enemyHRP = enemy.HumanoidRootPart
                -- Smooth lock behind enemy
                if heartbeatConnection then
                    heartbeatConnection:Disconnect()
                end
                heartbeatConnection = RunService.Heartbeat:Connect(function()
                    if enemy and enemy.Parent and enemy:FindFirstChild("HumanoidRootPart") then
                        local targetPos = GetSafeBehindPosition(enemyHRP)
                        hrp.CFrame = hrp.CFrame:Lerp(CFrame.new(targetPos, enemyHRP.Position + Vector3.new(0, aboveHeight, 0)), 0.35)
                    else
                        if heartbeatConnection then
                            heartbeatConnection:Disconnect()
                            heartbeatConnection = nil
                        end
                    end
                end)

                -- Attack
                game:GetService("ReplicatedStorage").Resource.Remotes.M1:FireServer({ type = "M1", InAir = false, UpTilt = false })
                AttachSuperKill(enemy)
            else
                -- No enemy: lock at zone
                if not zoneLockConnection then
                    LockAtZone(zoneCFrame)
                end
            end

            task.wait(0.1)
        until not IsInQuest()

        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
        DetachZoneLock()
    end

    -- =======================
    -- Normal Autofarm Toggle
    -- =======================
    FarmTab:CreateToggle({
        Name = "AutoFarm (Highest Quest)",
        CurrentValue = false,
        Flag = "AutoFarmToggle",
        Callback = function(state)
            autoFarmEnabled = state

            if state then
                task.spawn(function()
                    QuestEvent:FireServer({ Type = "RemoveQuest" })
                    task.wait(0.2)
                    while autoFarmEnabled do
                        local level = player:WaitForChild("Data").Level.Value
                        local bestQuest = nil
                        for _, q in ipairs(quests) do
                            if level >= q.MinLevel then
                                bestQuest = q
                            end
                        end
                        if bestQuest then
                            FarmQuest(bestQuest)
                        else
                            task.wait(1)
                        end
                    end
                end)
            else
                QuestEvent:FireServer({ Type = "RemoveQuest" })
                if heartbeatConnection then heartbeatConnection:Disconnect() heartbeatConnection = nil end
                DetachZoneLock()
            end
        end
    })

    -- =======================
    -- Multi-Quest Farm
    -- =======================
    local questOptions = {}
    for _, q in ipairs(quests) do
        table.insert(questOptions, q.DisplayName)
    end

    FarmTab:CreateDropdown({
        Name = "Select Quests to Farm",
        Options = questOptions,
        CurrentOption = {},
        MultipleOptions = true,
        Flag = "MultiQuestDropdown",
        Callback = function(options)
            selectedQuests = options
        end
    })

    FarmTab:CreateToggle({
        Name = "Enable Multi-Quest Farm",
        CurrentValue = false,
        Flag = "MultiQuestToggle",
        Callback = function(state)
            multiQuestEnabled = state

            if state then
                task.spawn(function()
                    QuestEvent:FireServer({ Type = "RemoveQuest" })
                    task.wait(0.1)
                    while multiQuestEnabled do
                        if #selectedQuests == 0 then
                            task.wait(0.5)
                        else
                            for _, questName in ipairs(selectedQuests) do
                                if not multiQuestEnabled then break end
                                local questData = nil
                                for _, q in ipairs(quests) do
                                    if q.DisplayName == questName then
                                        questData = q
                                        break
                                    end
                                end
                                if questData then
                                    FarmQuest(questData)
                                end
                            end
                        end
                    end
                end)
            else
                QuestEvent:FireServer({ Type = "RemoveQuest" })
                if heartbeatConnection then heartbeatConnection:Disconnect() heartbeatConnection = nil end
                DetachZoneLock()
            end
        end
    })

    -- =======================
    -- SuperKill Toggle
    -- =======================
    FarmTab:CreateToggle({
        Name = "SuperKill (Instakill Target)",
        CurrentValue = false,
        Flag = "SuperKillToggle",
        Callback = function(state)
            superKillEnabled = state
        end
    })
end
