-- =======================
-- MultiQuestFarm Module (Locked Behind Enemy Version)
-- =======================
return function(player, QuestEvent, quests, teleportZones, RunService, FarmTab)
    local multiQuestToggle = nil
    local multiQuestDropdown = nil
    local multiQuestEnabled = false
    local selectedQuests = {}

    -- Helpers
    local function IsInQuest()
        local questFrame = player.PlayerGui:FindFirstChild("Quest") and player.PlayerGui.Quest:FindFirstChild("Mission")
        return questFrame and questFrame.Visible or false
    end

    local function TeleportToZone(level)
        for _, zone in ipairs(teleportZones) do
            if level >= zone.Min and level <= zone.Max then
                local hrp = player.Character:WaitForChild("HumanoidRootPart")
                hrp.CFrame = zone.CFrame
                break
            end
        end
    end

    local function ZeroVelocity()
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            hrp.Velocity = Vector3.zero
            hrp.AssemblyLinearVelocity = Vector3.zero
        end
    end

    -- Toggle
    multiQuestToggle = FarmTab:CreateToggle({
        Name = "Enable Multi-Quest Farm",
        CurrentValue = false,
        Flag = "MultiQuestToggle",
        Callback = function(state)
            multiQuestEnabled = state

            if state then
                task.spawn(function()
                    -- Cancel leftover quests once
                    QuestEvent:FireServer({ Type = "RemoveQuest" })
                    task.wait(0.1)

                    while multiQuestEnabled do
                        for _, questName in ipairs(selectedQuests) do
                            if not multiQuestEnabled then break end

                            -- Find quest data
                            local questData = nil
                            for _, q in ipairs(quests) do
                                if q.DisplayName == questName then
                                    questData = q
                                    break
                                end
                            end
                            if not questData then continue end

                            -- Teleport to zone
                            TeleportToZone(questData.MinLevel)
                            task.wait(0.3)

                            -- Start quest if not already
                            if not IsInQuest() then
                                QuestEvent:FireServer({ Quest = questData.QuestName, Type = "RepeatQuest" })
                            end

                            -- Wait until quest is active
                            repeat task.wait(0.1) until IsInQuest() or not multiQuestEnabled

                            -- Farm enemies
                            if IsInQuest() then
                                local hrp = player.Character:WaitForChild("HumanoidRootPart")

                                repeat
                                    if not multiQuestEnabled then break end
                                    ZeroVelocity()

                                    local enemy = nil
                                    for _, mob in pairs(workspace.Mobs:GetChildren()) do
                                        local levelNum = tonumber(mob.Name:match("Lv(%d+)"))
                                        if levelNum == questData.MinLevel and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                                            enemy = mob
                                            break
                                        end
                                    end

                                    if enemy and enemy:FindFirstChild("HumanoidRootPart") then
                                        local enemyHRP = enemy.HumanoidRootPart
                                        -- stay locked behind enemy
                                        hrp.CFrame = CFrame.new(
                                            enemyHRP.Position - enemyHRP.CFrame.LookVector * 5,
                                            enemyHRP.Position
                                        )

                                        -- spam M1
                                        game:GetService("ReplicatedStorage").Resource.Remotes.M1:FireServer({
                                            type = "M1",
                                            InAir = false,
                                            UpTilt = false
                                        })
                                    end

                                    task.wait(0.1)
                                until not IsInQuest() or not multiQuestEnabled
                            end
                        end
                    end
                end)
            else
                -- Cancel quest to reset & stop farming
                QuestEvent:FireServer({ Type = "RemoveQuest" })
            end
        end
    })

    -- Dropdown
    local questOptions = {}
    for _, q in ipairs(quests) do
        table.insert(questOptions, q.DisplayName)
    end

    multiQuestDropdown = FarmTab:CreateDropdown({
        Name = "Select Quests to Farm",
        Options = questOptions,
        CurrentOption = {},
        MultipleOptions = true,
        Flag = "MultiQuestDropdown",
        Callback = function(options)
            selectedQuests = options
        end
    })
end
