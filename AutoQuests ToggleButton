-- AutoQuestToggle.lua (your loadie)
return function(player, QuestEvent, quests, RunService, Tab)
    local autoQuestEnabled = false
    local autoQuestLoop

    local function GetHighestQuest()
        local level = player:WaitForChild("Data"):WaitForChild("Level").Value
        local selected
        for _, q in ipairs(quests) do
            if level >= q.MinLevel then
                selected = q
            end
        end
        return selected
    end

    local function IsInQuest()
        local questFrame = player.PlayerGui:FindFirstChild("Quest") and player.PlayerGui.Quest:FindFirstChild("Mission")
        return questFrame and questFrame.Visible or false
    end

    -- Create the toggle inside the provided tab
    Tab:CreateToggle({
        Name = "Enable AutoQuest",
        CurrentValue = false,
        Flag = "AutoQuestToggle",
        Callback = function(state)
            autoQuestEnabled = state

            if state then
                QuestEvent:FireServer({Type = "RemoveQuest"})
                task.wait(0.1)

                autoQuestLoop = RunService.Heartbeat:Connect(function()
                    if not autoQuestEnabled then return end
                    if IsInQuest() then return end
                    local quest = GetHighestQuest()
                    if quest then
                        QuestEvent:FireServer({Quest = quest.QuestName, Type = "RepeatQuest"})
                    end
                end)
            else
                if autoQuestLoop then
                    autoQuestLoop:Disconnect()
                    autoQuestLoop = nil
                end
                QuestEvent:FireServer({Type = "RemoveQuest"})
            end
        end
    })
end
