-- =======================
-- Main Tab Module (Fixed AutoQuest Timing)
-- version: 1.10
-- =======================

return function(Window, player, QuestEvent, quests, RunService)
    -- Create Main Tab
    local MainTab = Window:CreateTab("Main", "scroll")

    -- =======================
    -- Quest Info Section
    -- =======================
    MainTab:CreateSection("Quest Info")
    local questInfoLabel = MainTab:CreateLabel("Current Level: 0\nCurrent Quest: None | Next Quest: None")

    RunService.Heartbeat:Connect(function()
        local level = player:WaitForChild("Data"):WaitForChild("Level").Value

        -- Sort quests by MinLevel ascending
        table.sort(quests, function(a, b)
            return a.MinLevel < b.MinLevel
        end)

        local highestQuest, nextQuest
        for _, q in ipairs(quests) do
            if level >= q.MinLevel then
                highestQuest = q
            elseif not nextQuest then
                nextQuest = q
            end
        end

        local currentQuestText = highestQuest and highestQuest.DisplayName or "None"
        local nextQuestText = nextQuest and nextQuest.DisplayName or "Max"

        questInfoLabel:Set(string.format(
            "Current Level: %d\nCurrent Quest: %s | Next Quest: %s",
            level,
            currentQuestText,
            nextQuestText
        ))
    end)

    -- =======================
    -- AutoQuest Section
    -- =======================
    MainTab:CreateSection("Auto Quests")

    local autoQuestEnabled = false
    local autoQuestLoop

    local function GetHighestQuest()
        local level = player:WaitForChild("Data"):WaitForChild("Level").Value
        local selected
        for _, q in ipairs(quests) do
            if level >= q.MinLevel then
                selected = q
            end
        end
        return selected
    end

    local function IsInQuest()
        local questFrame = player.PlayerGui:FindFirstChild("Quest") and player.PlayerGui.Quest:FindFirstChild("Mission")
        return questFrame and questFrame.Visible or false
    end

    MainTab:CreateToggle({
        Name = "AutoQuest (Highest Available)",
        CurrentValue = false,
        Flag = "AutoQuestToggle",
        Callback = function(state)
            autoQuestEnabled = state

            if state then
                QuestEvent:FireServer({Type = "RemoveQuest"})
                task.wait(0.1)

                autoQuestLoop = task.spawn(function()
                    while autoQuestEnabled do
                        if IsInQuest() then
                            task.wait(0.1)
                            continue
                        end

                        -- Delay briefly after finishing a quest to allow level updates
                        task.wait(1)

                        local quest = GetHighestQuest()
                        if quest then
                            QuestEvent:FireServer({Quest = quest.QuestName, Type = "RepeatQuest"})
                        end

                        task.wait(0.1)
                    end
                end)
            else
                if autoQuestLoop then
                    task.cancel(autoQuestLoop)
                    autoQuestLoop = nil
                end
                QuestEvent:FireServer({Type = "RemoveQuest"})
            end
        end
    })

    -- =======================
    -- Auto Start Specific Quest
    -- =======================
    local selectedQuest = quests[1].DisplayName
    local autoStartSpecificEnabled = false
    local specificQuestConnection

    MainTab:CreateToggle({
        Name = "Start Specific Quest",
        CurrentValue = false,
        Flag = "AutoStartSpecificToggle",
        Callback = function(state)
            autoStartSpecificEnabled = state

            if state then
                QuestEvent:FireServer({Type = "RemoveQuest"})

                specificQuestConnection = RunService.Heartbeat:Connect(function()
                    if not autoStartSpecificEnabled then return end

                    local questFrame = player.PlayerGui:FindFirstChild("Quest") 
                        and player.PlayerGui.Quest:FindFirstChild("Mission")
                    local inQuest = questFrame and questFrame.Visible or false

                    if not inQuest then
                        local questObj
                        for _, q in ipairs(quests) do
                            if q.DisplayName == selectedQuest then
                                questObj = q
                                break
                            end
                        end
                        if questObj then
                            QuestEvent:FireServer({Quest = questObj.QuestName, Type = "RepeatQuest"})
                        end
                    end
                end)
            else
                if specificQuestConnection then
                    specificQuestConnection:Disconnect()
                    specificQuestConnection = nil
                end
                QuestEvent:FireServer({Type = "RemoveQuest"})
            end
        end
    })

    local questOptions = {}
    for _, q in ipairs(quests) do
        table.insert(questOptions, q.DisplayName)
    end

    MainTab:CreateDropdown({
        Name = "Choose Quest",
        Options = questOptions,
        CurrentOption = {questOptions[1]},
        MultipleOptions = false,
        Flag = "SpecificQuestDropdown",
        Callback = function(options)
            selectedQuest = options[1]
        end
    })

    -- =======================
    -- Misc Section
    -- =======================
    MainTab:CreateSection("Misc")

    local autoRollEnabled = false
    local autoRollThread
    local inventoryCheckThread
    local serverEvent = game:GetService("ReplicatedStorage").Resource.Remotes.Bindable.Server

    -- Default 30 minutes
    local rollCooldown = 30

    local function RollFruit()
        serverEvent:InvokeServer({ Arg = "MovesetSpin" })
    end

    local function StoreFruit()
        serverEvent:InvokeServer({ Arg = "StoreFruit" })
    end

    local function EquipAndStoreFruit()
        local backpack = player:FindFirstChild("Backpack")
        local character = player.Character
        if not backpack or not character then return end

        local fruit = backpack:FindFirstChild("Fruit")
        if fruit then
            character.Humanoid:EquipTool(fruit)
            task.wait(0.5)
            StoreFruit()
        end
    end

    MainTab:CreateToggle({
        Name = "AutoRollFruit",
        CurrentValue = false,
        Flag = "AutoRollFruitToggle",
        Callback = function(state)
            autoRollEnabled = state

            if state then
                RollFruit()
                task.wait(1)
                EquipAndStoreFruit()

                -- Roll loop
                autoRollThread = task.spawn(function()
                    while autoRollEnabled do
                        for i = 1, rollCooldown * 60 do
                            if not autoRollEnabled then break end
                            task.wait(1)
                        end
                        if autoRollEnabled then
                            RollFruit()
                            task.wait(1)
                            EquipAndStoreFruit()
                        end
                    end
                end)

                -- Inventory check every 5 seconds
                inventoryCheckThread = task.spawn(function()
                    while autoRollEnabled do
                        EquipAndStoreFruit()
                        for i = 1, 5 do
                            if not autoRollEnabled then break end
                            task.wait(1)
                        end
                    end
                end)
            else
                autoRollEnabled = false
            end
        end
    })

    -- Slider below toggle
    MainTab:CreateSlider({
        Name = "AutoRoll Interval",
        Range = {10, 60},
        Increment = 1,
        Suffix = "min",
        CurrentValue = 30,
        Flag = "AutoRollInterval",
        Callback = function(value)
            rollCooldown = value
        end
    })

    return MainTab
end
